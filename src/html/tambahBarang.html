<section class="section main-section">
  <div class="card">
    <header class="card-header">
      <p class="card-header-title">
        <span class="icon"><i class="mdi mdi-plus-box"></i></span>
        Form Tambah Barang
      </p>
    </header>
    <div class="card-content">
      <form id="formTambahBarang">
        <div class="field">
          <label class="label">Nama Barang</label>
          <div class="control">
            <input type="text" autocomplete="off" name="nama" class="input" required
              placeholder="Contoh: Lemari MS 3 susun">
          </div>
        </div>

        <div class="field">
          <label class="label">Deskripsi <small>(opsional)</small></label>
          <div class="control">
            <textarea name="deskripsi" autocomplete="off" class="textarea"
              placeholder="Deskripsi barang (boleh dikosongkan)"></textarea>
          </div>
        </div>

        <div class="field">
          <label class="label">Stok</label>
          <div class="control">
            <input type="number" min="0" name="stok" class="input" required placeholder="Contoh: 3">
          </div>
        </div>

        <div class="field">
          <label class="label">Harga</label>
          <div class="control">
            <input type="number" min="0" name="harga" class="input" autocomplete="off" required
              placeholder="Contoh: 400000">
          </div>
        </div>

        <div class="field">
          <label class="label">Kategori</label>
          <div class="control">
            <div class="select">
              <select name="kategori" required>
                <option value="">-- Pilih Kategori --</option>
                <option value="Parabot">Parabot</option>
                <option value="Aksesoris">Aksesoris</option>
                <option value="Kosmetik">Kosmetik</option>
                <option value="Perlengkapan">Perlengkapan</option>
                <option value="Elektronik">Elektronik</option>
              </select>
            </div>
          </div>
        </div>

        <div class="field">
          <label class="label">Upload Gambar <small>(opsional)</small></label>
          <div class="control">
            <input type="file" accept="image/*" id="gambarUpload">
          </div>
        </div>

        <div class="field">
          <label class="label">URL Gambar <small>(opsional)</small></label>
          <div class="control">
            <input type="url" autocomplete="off" name="gambar" class="input" placeholder="https://link-gambar.jpg">
          </div>
        </div>

        <hr>

        <div class="field grouped">
          <div class="control">
            <button type="submit" class="button green">Simpan</button>
          </div>
          <div class="control">
            <button type="reset" class="button red">Reset</button>
          </div>
        </div>
      </form>
    </div>

    <div class="card-content">
      <div id="qrSection" class="hidden mt-5 flex-col items-center">
        <h2 class="text-xl font-semibold mb-4">QR Code Barang</h2>
        <img id="qrImage" alt="QR Code" class="max-w-xs" />
        <button onclick="cetakQRLabelPDF()" class="mt-4 button blue">Cetak PDF</button>
      </div>
    </div>
  </div>
</section>

<script>
  document.getElementById("formTambahBarang").addEventListener("submit", async function (e) {
    e.preventDefault();

    const form = e.target;

    const data = {
      nama: form.nama.value,
      deskripsi: form.deskripsi.value,
      stok: parseInt(form.stok.value),
      harga: parseInt(form.harga.value),
      kategori: form.kategori.value,
      gambar: form.querySelector('[name="gambar"]').value || null
    };

    try {
      const res = await fetch(`${API_URL}/barang`, {
        method: "POST",
        credentials: "include",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(data)
      });

      const result = await res.json();
      if (res.ok) {
        alert("Barang berhasil ditambahkan!");
        form.reset();
      } else {
        alert("Gagal: " + result.message);
      }
    } catch (err) {
      alert("Terjadi kesalahan: " + err.message);
    }
  });
</script>

<script>
  const uploadInput = document.getElementById("gambarUpload");
  const gambarUrlInput = document.querySelector("input[name='gambar']");

  uploadInput.addEventListener("change", async function () {
    const file = uploadInput.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append("image", file);

    try {
      const res = await fetch(`${API_URL}/upload`, {
        method: "POST",
        body: formData,
        credentials: "include"
      });

      const result = await res.json();
      if (res.ok && result.url) {
        gambarUrlInput.value = result.url;
        alert("Gambar berhasil diupload!");
      } else {
        alert("Upload gagal: " + result.message);
      }
    } catch (err) {
      alert("Upload error: " + err.message);
    }
  });
</script>